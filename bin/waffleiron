#!/bin/bash

#
## function defs
_help() {
  echo "init       ./bin/waffleiron init"
  echo "clean      ./bin/waffleiron clean"
  echo "symlinks   ./bin/waffleiron symlinks"
  echo "ls         ./bin/waffleiron ls"
}

if [ $# -eq 0 ]
  then
    echo "no args supplied \n\n"
    _help
fi

_ls() {
  ls -lah ./
}

_symlinks() {
  ln -s ./wp-config-default.php ./web/cms/wp-config.php
}

clean() {
  rm -rf vendor node_modules web/cms
  find . -maxdepth 1 ! -name util ! -name index.php -name plugins/. -delete;
}

rm_submodules() {
  git submodule deinit .
  git submodule | cut -c43- | while read -r line; do (git rm "$line"); done
  git config --local -l | grep submodule | sed -e 's/^\(submodule\.[^.]*\)\(.*\)/\1/g' | while read -r line; do (git config --local --remove-section "$line"); done
  rm .gitmodules
  rm -rf .git/modules
}

deploy() {
  rm_submodules
  clean
  composer install --no-dev
}

_restart() {
  lando start
  pull
  lando restart 
}

pull() {
  lando ssh -c "rm -f /app/database.sql.gz"
  lando terminus backup:create mcwaffleiron.dev --element=db
  lando terminus backup:get mcwaffleiron.dev --element=db --to=/app/database.sql.gz
  lando db-import database.sql.gz
}

install() {
  if [[ ($2 -eq "-c") || ($2 -eq "--clean") ]]
    then
      rm -rf vendor node_modules web/cms
  fi
  composer install
  pnpm install
  rm_submodules
}

# init function... used to be all the commands in composer.json but thats ugly dude
init() {
  clean
  install
  symlinks
  _restart
}

#
## do your business here
while [ "$1" != "" ]; do
  case "$1" in
    "init" )
      init ;;
    "install" )
      install ;;
    "clean" )
      clean ;;
    "help" )
      _help ;;
    "ls" )
      _ls ;;
    * )    
      echo 'suh?' ;;
  esac
  shift
done
